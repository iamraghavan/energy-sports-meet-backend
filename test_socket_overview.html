<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cricket Scoring - WebSocket Debugger</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; color: #1e293b; padding: 2rem; max-width: 1200px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); margin-bottom: 2rem; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .score-board { text-align: center; }
        .runs { font-size: 3rem; font-weight: bold; color: #0f172a; }
        .overs { font-size: 1.2rem; color: #64748b; }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        button { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { background: #f1f5f9; border-color: #cbd5e1; }
        button.primary { background: #3b82f6; color: white; border: none; }
        button.primary:hover { background: #2563eb; }
        button.danger { background: #ef4444; color: white; border: none; }
        #log { background: #0f172a; color: #4ade80; border-radius: 8px; padding: 1rem; font-family: monospace; height: 300px; overflow-y: auto; font-size: 0.85rem; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .error { color: #f87171; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üèè Live Cricket Scorer Debugger</h2>
        <div>
            <span id="status-dot" class="status-dot" style="background: grey;"></span>
            <span id="status-text">Disconnected</span>
        </div>
    </div>
    <div class="grid">
        <div class="score-board">
            <div id="team-name" style="font-weight: 600; font-size: 1.1rem;">Team A</div>
            <div class="runs" id="score-display">0/0</div>
            <div class="overs" id="over-display">(0.0 Overs)</div>
        </div>
        <div>
            <label>Match ID:</label>
            <input type="text" id="matchId" value="ENTER_MATCH_ID_HERE" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
            <p style="font-size: 0.8rem; color: #64748b;">Enter your active match UUID from the database.</p>
            <button class="primary" onclick="connect()" style="width: 100%;">Connect to WebSocket</button>
        </div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h3>Match Lifecycle</h3>
        <div style="display: flex; gap: 10px;">
            <button class="primary" onclick="updateStatus('live')">üöÄ Start Match (Live)</button>
            <button class="primary" onclick="updateStatus('completed')" style="background: #64748b;">üèÅ End Match (Completed)</button>
        </div>
        <h3>Log Ball Event</h3>
        <div class="btn-grid">
            <button onclick="logBall(0)">0</button>
            <button onclick="logBall(1)">1</button>
            <button onclick="logBall(2)">2</button>
            <button onclick="logBall(3)">3</button>
            <button onclick="logBall(4)">4</button>
            <button onclick="logBall(6)">6</button>
            <button onclick="logBall(0, true)" class="danger">WICKET</button>
            <button onclick="logBall(1, false, 'wide')">WIDE</button>
        </div>
        <div style="margin-top: 20px;">
            <label>Current Over:</label> <input type="number" id="over" value="0" style="width: 40px;">
            <label>Ball:</label> <input type="number" id="ball" value="1" style="width: 40px;">
        </div>
    </div>
    
    <div class="card">
        <h3>System Console</h3>
        <div id="log"></div>
    </div>
</div>

<script>
    let socket;
    const BACKEND_URL = "https://energy-sports-meet-backend.onrender.com";

    function log(msg, type = 'info') {
        const div = document.createElement('div');
        div.className = `log-entry ${type === 'error' ? 'error' : ''}`;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        const logContainer = document.getElementById('log');
        logContainer.appendChild(div);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function connect() {
        const matchId = document.getElementById('matchId').value;
        if (!matchId || matchId === 'ENTER_MATCH_ID_HERE') {
            alert("Please enter a valid Match ID first!");
            return;
        }

        if (socket) socket.disconnect();

        log(`Connecting to ${BACKEND_URL}...`);
        
        socket = io(BACKEND_URL, {
            transports: ["websocket", "polling"], // üì° Added polling as fallback
            upgrade: true,
            timeout: 60000, // ‚è±Ô∏è Increased to 1 minute for Cold Starts
            reconnection: true,
            reconnectionAttempts: 5
        });

        socket.on('connect', () => {
            document.getElementById('status-dot').style.background = '#4ade80';
            document.getElementById('status-text').innerText = 'Connected';
            log(`SUCCESS: Connected! Socket ID: ${socket.id}`);
            
            socket.emit('join_match', matchId);
            log(`Joined Match Room: ${matchId}`);
        });

        socket.on('connect_error', (err) => {
            log(`CONNECTION ERROR: ${err.message}`, 'error');
            document.getElementById('status-dot').style.background = '#f87171';
            document.getElementById('status-text').innerText = 'Error';
        });

        socket.on('cricket_score_update', (data) => {
            log(`üì° REAL-TIME UPDATE RECEIVED: ${JSON.stringify(data.score)}`);
            updateUI(data.score);
        });

        socket.on('disconnect', (reason) => {
            document.getElementById('status-dot').style.background = 'grey';
            document.getElementById('status-text').innerText = 'Disconnected';
            log(`Disconnected: ${reason}`, 'error');
        });
    }

    function updateStatus(newStatus) {
        if (!socket || !socket.connected) {
            log("‚ùå ERROR: Not connected to server!", "error");
            return;
        }

        const matchId = document.getElementById('matchId').value;
        const payload = {
            matchId,
            status: newStatus
        };

        log(`üì§ TRANSITIONING: Match status to ${newStatus.toUpperCase()}...`);
        
        socket.emit('update_match_status', payload, (res) => {
            if (res.status === 'ok') {
                log(`‚úÖ SUCCESS: Match is now ${newStatus.toUpperCase()}`);
            } else {
                log(`‚ùå FAILED: ${res.message}`, "error");
            }
        });
    }

    function logBall(runs, isWicket = false, extraType = null) {
        if (!socket || !socket.connected) {
            log("‚ùå ERROR: Not connected to server!", "error");
            return;
        }

        const matchId = document.getElementById('matchId').value;
        const over = parseInt(document.getElementById('over').value);
        const ball = parseInt(document.getElementById('ball').value);

        const payload = {
            matchId,
            runs: runs,
            is_wicket: isWicket,
            batting_team_id: "TEAM_ID_HERE", // Replace with real ID
            over_number: over,
            ball_number: ball,
            extra_type: extraType,
            extras: extraType ? 1 : 0
        };

        log(`üì§ SENDING: ${runs} runs${isWicket ? ' + Wicket' : ''}...`);
        
        socket.emit('submit_cricket_ball', payload, (res) => {
            if (res.status === 'ok') {
                log("‚úÖ SERVER ACKNOWLEDGED: Score stored in DB.");
                // Manual ball increment for demo
                if (ball < 6) document.getElementById('ball').value = ball + 1;
                else {
                    document.getElementById('over').value = over + 1;
                    document.getElementById('ball').value = 1;
                }
            } else {
                log(`‚ùå SERVER REJECTED: ${res.message}`, "error");
            }
        });
    }

    function updateUI(scoreDetails) {
        // Just pick the first team in the score object for display
        const teamIds = Object.keys(scoreDetails);
        if (teamIds.length > 0) {
            const teamA = scoreDetails[teamIds[0]];
            document.getElementById('score-display').innerText = `${teamA.runs}/${teamA.wickets}`;
            document.getElementById('over-display').innerText = `(${teamA.overs || '0.0'} Overs)`;
        }
    }
</script>
</body>
</html>

